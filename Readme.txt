psisiarc - MPEG-TSからPSI/SI等を抽出して書庫に保存する

使用法:

psisiarc [-p pids][-n prog_num_or_index][-t stream_types][-r preset][-i interval][-b maxbuf_kbytes][-c chapter][-s pattern][-e pattern] src dest

-p pids, default=""
  抽出するTSパケットのPIDを'/'区切りで指定。
  内容がセクション形式のストリームに限る。

-n prog_num_or_index, -256<=range<=65535, default=0
  抽出するサービスを指定。
  サービスID(1以上)かPAT(Program Association Table)上の並び順(先頭を-1として-1,-2,..)を指定する。
  このオプションを0以外にすると、PATとPMT(Program Map Table)とNIT(Network Information Table)が抽出対象に加えられる。
  このオプションが0のとき"-t"オプションは無視される。

-t stream_types, 0<=range<=255, default=""
  抽出するPMT上のストリーム形式種別(Stream type)を'/'区切りで指定。
  内容がセクション形式のストリームに限る。

-r preset
  事前定義されたオプションを追加する。今のところ以下のみ。
  - "arib-data": オプション -p 17/18/20/31/36 -n -1 -t 11/12/13 と等価。データ放送の保存用。
  - "arib-epg": オプション -p 17/18/20/31/36 -n -1 と等価。番組情報の保存用。

-i interval (seconds), 0<=range<=600, default=0
  PCR(Program Clock Reference)を基準に一定間隔で書庫を出力する。
  "-n"オプションを0以外にすること。
  ストリーミングなどで書庫を速やかに展開する必要があるときに使う。

-b maxbuf_kbytes (kbytes), 8<=range<=1048576, default=16384
  書庫を展開するとき必要になる最大メモリ占有量の目安。
  小さくしすぎると書庫の内部で分割が発生してファイルサイズが大きくなる。

-c chapter, default=""
  出力をカット編集する場合、Nero/OGM形式のチャプターファイル名。
  文字コードはUTF-8やShift_JISなどの8bitベースで以下のような形式のもの:
  > CHAPTER01=00:00:00.000
  > CHAPTER01NAME=編集点開始
  > CHAPTER02=01:23:45.678
  > CHAPTER02NAME=編集点終了

-s pattern, default="^ix"
  出力をカット編集する場合、カット開始チャプター名のパターン。
  "^..." (前方一致)、"...$" (後方一致)、"^...$" (完全一致)、または部分一致。
  非ASCII文字を \x?? (??は16進数)でエスケープできる。
  大文字小文字は区別されない。
  たとえばチャプターファイルがShift_JISのとき、チャプター名が"開始"で終わるチャプターでカットしたいなら
  > -s '\x8A\x4A\x8E\x6E$'
  のようにする。

-e pattern, default="^ox"
  出力をカット編集する場合、カット終了チャプター名のパターン。
  "-s"オプションと同様。
  たとえばチャプターファイルがShift_JISのとき、チャプター名が"終了"で終わるチャプターまでカットしたいなら
  > -e '\x8F\x49\x97\xB9$'
  のようにする。

src
  入力ファイル名、または"-"で標準入力。

dest
  出力書庫名、または"-"で標準出力。

説明:

たとえば
> psisiarc -r arib-data foo.m2t foo.psc
とすると、TSファイルに含まれるデータ放送の再生に必要な情報を保存できる。

その他:

ライセンスはMITとする。

(付録)書庫のデータ構造:

  (チャンク)
    (ヘッダ 32bytes)
    マジックナンバー: Pssc\x0d\x0a\x9a\x0a (8bytes)
    予約: \0\0 (2bytes)
    時刻リスト長: 後述の時刻リストの長さ (2bytes)
    辞書長: 後述の辞書の長さ (2bytes)
            常に辞書ウィンドウ長以下
    辞書ウィンドウ長: (メモリ上の)辞書全体の長さ(辞書長と、前回辞書を引き継ぐ長さの和) (2bytes)
                      常に0～{65536-4096}
    辞書データサイズ: 後述のPIDリストとセクション集合のバイト数の和 (4bytes)
                      常に辞書バッファサイズ以下
    辞書バッファサイズ: 引き継いだ前回辞書を含めた(メモリ上の)PIDリストとセクション集合のバイト数の和 (4bytes)
                        常に"-b"オプションの値以下
    符号リスト長: 後述の符号リストの長さ (4bytes)
                  常に時刻リストに出現する符号の数の総和と同じ
    予約: \0\0\0\0 (4bytes)
    (ヘッダここまで)

    (データ部分)
    時刻リスト: 4bytes整数列。後述の符号リストの符号ごとの出現タイミング
                値が0x80000000以上のとき、時刻を30bit、1/11250秒単位で表現。時刻はPCRなどで、巡回しうる
                とくに値が0xffffffffのとき、時刻不明を意味する
                値が0x80000000未満のとき、下位16bitに0または正の経過時間、上位15bitにこの時刻に出現する{符号の数-1}
    辞書: 2bytes整数列。値が4096以上のとき前回辞書IDの参照、未満のとき{セクションサイズ-1}を意味する
          この列の順にセクションに対して辞書IDを4096から割り振り、さらに辞書ウィンドウ長まで、前回辞書のうち未参照のもの
          を今回辞書に引き継ぐ
    PIDリスト: 2bytes整数列。TSパケットのPIDと0xe000のOR演算値。辞書の値が4096未満のものだけ記録
    セクション集合: PSI/SI等のセクションデータそのもの。辞書の値が4096未満のものだけ記録
    アライメント: 辞書データサイズが奇数のとき1byteの"\xff"
    符号リスト: 2bytes整数列。辞書IDの列
    (データ部分ここまで)

    トレーラ: データ部分のバイト数が4の倍数なら4bytesの"===="、そうでなければ2bytesの"=="
              次のチャンクを追記する直前か出力を完了するまで書き込まない
  (チャンクここまで)

・書庫はチャンクを任意の個数追記したもの
・ファイル終端を含むマジックナンバーを読み取れなくなるまでが書庫の範囲
・リトルエンディアン
・セクションデータを辞書化して格納するため、再送されたセクションは書庫サイズにほとんど影響しない
